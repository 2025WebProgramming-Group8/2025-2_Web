{% extends 'base.html' %} 
{% block title %}타이머{% endblock %}

{% block top_area %}
    <div class="topbar" style="max-width:1100px;margin:16px auto 0;padding:0 20px">
        <div class="btn" aria-label="뒤로">←</div>
        <div class="room" aria-label="스터디룸 이름">{{ study.name }}</div>
        <div class="btn" aria-label="홈">홈</div>
    </div> 
{% endblock %}

{% block header_content %}
    {% endblock %}

{% block content %}
  <style>
    :root{ --bg:#0e0f13; --panel:#161821; --ink:#e9eaf3; --muted:#a4a7b8; --line:#232637; --accent:#93b2ff; --ok:#79e08f; --warn:#fbc531; --err:#ff6b6b; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; }
    a{ color:inherit; text-decoration:none }

    /* Layout */
    .wrap{ max-width:1100px; margin:24px auto; padding:0 20px; display:grid; grid-template-columns: 1fr 320px; gap:16px }
    .panel{ background:#1b1e2a; border:1px solid var(--line); border-radius:14px; padding:14px }

    /* Top bar */
    .topbar{ display:grid; grid-template-columns:80px 1fr 80px; gap:10px; margin-bottom:12px }
    .btn{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:10px 12px; text-align:center; cursor:default }
    .room{ background:#161821; border:1px solid var(--line); border-radius:10px; padding:10px 12px; text-align:center; font-weight:800 }

    /* Left  */
    .left{ display:grid; gap:16px }
    .char{ height:220px; display:grid; place-items:center; color:var(--muted); border-radius:12px; border:1px dashed #2a2f47 }

    .members{ display:grid; gap:10px }
    .row{ display:grid; grid-template-columns: 110px 70px 100px 60px 80px; gap:10px; align-items:center }
    .pill{ background:#23273a; border:1px solid var(--line); border-radius:999px; padding:8px 10px; text-align:center; font-weight:800 }
    .state.on{ background:#14361d; border-color:#1f6f38; color:#b9ffd0 }
    .state.off{ background:#3a1918; border-color:#7a2a26; color:#ffd1cc }
    .state.rest{ background:#3a3314; border-color:#7a6a1f; color:#fff0b3 }
    .timebox, .lvl{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:8px 10px; text-align:center }
    .avatar{ width:34px; height:34px; border-radius:999px; background:#2a2f47; border:1px solid var(--line) }

    /* Right */
    .timer{ display:grid; gap:10px }
    .timer .face{ background:#0f121d; border:1px solid var(--line); border-radius:12px; padding:18px; text-align:center; font-size:40px; font-weight:900; letter-spacing:1px }
    .timer .cta{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:12px; text-align:center; font-weight:800 }

    /* Chat input */
    .chat{ max-width:1100px; margin:0 auto 26px; padding:0 20px }
    .chat input{ width:100%; background:#161821; border:1px solid var(--line); border-radius:12px; padding:14px 16px; color:var(--ink) }

    @media (max-width:950px){ .wrap{ grid-template-columns:1fr } }
  </style>
    <section class="left">
        <div class="panel char">캐릭터 사진과 상태</div>

        <div class="panel members" aria-label="그룹원 현황">
            {% for member_link in groups %} 
            <div class="row" data-user-id="{{ member_link.user.id }}">
                <div class="pill">{{ member_link.user.profile.nickname|default:member_link.user.username }}</div>
                <div class="pill state off">OFF</div>
                
                <div class="timebox">
                    {{ member_link.group_study_time|default:"0:00:00" }}
                </div>
                
                <div class="avatar"></div>
                <div class="lvl">Lv. {{ member_link.user.profile.level }}</div>
            </div>
            {% endfor %}
        </div>
    </section>

    <aside class="panel timer" aria-label="타이머">
    <div class="face">0:00:00</div>
    
    <div class="cta">
        {% if is_member %}
            <span style="cursor:pointer">공부 시작</span>
        {% else %}
            <form action="{% url 'join_study' study.group_code %}" method="post">
                {% csrf_token %}
                <button type="submit" style="background:none; border:none; color:#93b2ff; font-weight:800; font-size:inherit; cursor:pointer;">
                    스터디 가입하기
                </button>
            </form>
        {% endif %}
        </div>
    </aside>

<script src="http://127.0.0.1:3000/socket.io/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // ----------------------------------------------------
    // 1. 기본 설정 및 변수
    // ----------------------------------------------------
    const socket = io('http://127.0.0.1:3000');
    
    const myUserId = String("{{ request.user.id }}");
    const myNickname = "{{ request.user.profile.nickname|default:request.user.username }}";
    const studyRoomId = "{{ study.id }}";

    // UI 요소 가져오기
    const timerFace = document.querySelector('.timer .face');
    const ctaButtonContainer = document.querySelector('.timer .cta');
    const ctaButtonSpan = ctaButtonContainer ? ctaButtonContainer.querySelector('span') : null;
    const memberRowsContainer = document.querySelector('.members');
    
    // 채팅 관련 요소
    const chatInput = document.getElementById('chat-input');
    const chatBox = document.getElementById('chat-box');

    // 타이머 변수
    let myCurrentTime = parseInt("{{ initial_time|default:'0' }}", 10);
    if (isNaN(myCurrentTime)) myCurrentTime = 0;
    
    let timerInterval = null;
    let isStudying = false;

    // ----------------------------------------------------
    // 2. 타이머 기능
    // ----------------------------------------------------
    function formatTime(seconds) {
        const h = String(Math.floor(seconds / 3600));
        const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    timerFace.textContent = formatTime(myCurrentTime);

    function updateTimerUI(studying) {
        isStudying = studying;
        if (isStudying) {
            if (ctaButtonSpan) ctaButtonSpan.textContent = "공부 중지";
            if (ctaButtonContainer) ctaButtonContainer.classList.add('cta-studying');
            if (!timerInterval) {
                timerInterval = setInterval(() => {
                    myCurrentTime++;
                    timerFace.textContent = formatTime(myCurrentTime);
                }, 1000);
            }
        } else {
            if (ctaButtonSpan) ctaButtonSpan.textContent = "공부 시작";
            if (ctaButtonContainer) ctaButtonContainer.classList.remove('cta-studying');
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
    }

    if (ctaButtonContainer && ctaButtonSpan) {
        ctaButtonContainer.addEventListener('click', () => {
            const action = isStudying ? 'stop' : 'start';
            socket.emit('timer_action', {
                room: studyRoomId,
                userId: myUserId,
                action: action,
                currentTime: myCurrentTime
            });
            updateTimerUI(!isStudying);
        });
    }

    // ----------------------------------------------------
    // 3. 채팅 기능 (수정됨)
    // ----------------------------------------------------
    if (chatInput) {
        chatInput.addEventListener('keydown', (e) => {
            // 한글 입력 중(조합 중)일 때는 엔터 이벤트를 무시 (중복 전송 방지)
            if (e.isComposing) return;

            if (e.key === 'Enter') {
                const msg = chatInput.value.trim();
                if (!msg) return;

                console.log("메시지 전송:", msg); // 디버깅용

                socket.emit('chat_message', {
                    room: studyRoomId,
                    nickname: myNickname,
                    message: msg,
                    userId: myUserId
                });

                chatInput.value = ''; // 입력창 비우기
            }
        });
    }

    // ----------------------------------------------------
    // 4. 소켓 이벤트 리스너
    // ----------------------------------------------------
    socket.on('connect', () => {
        console.log('✅ 소켓 연결됨');
        if (studyRoomId && myUserId && myUserId !== 'None') {
            socket.emit('join_room', { roomId: studyRoomId, userId: myUserId });
        }
    });

    // 타이머/상태 업데이트 수신
    socket.on('status_update', (allUsersStatus) => {
        const myUserIdString = String(myUserId);
        const myStatus = allUsersStatus[myUserIdString];

        // 내 상태 동기화
        if (myStatus) {
            if (myStatus.time > myCurrentTime) {
                myCurrentTime = myStatus.time;
                timerFace.textContent = formatTime(myCurrentTime);
            }
            if (isStudying !== myStatus.isStudying) {
                updateTimerUI(myStatus.isStudying);
            }
        }

        // 다른 멤버 업데이트
        memberRowsContainer.querySelectorAll('.row').forEach(row => {
            const memberId = String(row.dataset.userId);
            const status = allUsersStatus[memberId];
            if (!status) return;

            const statusPill = row.querySelector('.state');
            const timeBox = row.querySelector('.timebox');

            if (status.time) timeBox.textContent = formatTime(status.time);

            statusPill.classList.remove('on', 'off');
            if (status.isStudying) {
                statusPill.textContent = "ON";
                statusPill.classList.add('on');
            } else {
                statusPill.textContent = "OFF";
                statusPill.classList.add('off');
            }
        });
    });

    // 채팅 메시지 수신
    socket.on('new_chat', (data) => {
        const div = document.createElement('div');
        if (String(data.userId) === String(myUserId)) {
            div.className = 'msg me';
            div.textContent = data.message;
        } else {
            div.className = 'msg other';
            div.innerHTML = `<span class="msg-name">${data.nickname}</span>${data.message}`;
        }
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    });
});
</script>
{% endblock %}

{% block chat_input %}
<style>
    /* 채팅 전체 래퍼 */
    .chat-wrapper { 
        max-width: 1100px;
        margin: 0 auto 26px;
        padding: 0 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* 메시지가 쌓이는 공간 */
    .chat-box {
        height: 350px; /* 이거 수정해서 세로길이 늘리면 된 */
        background: #161821;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 16px;
        overflow-y: auto; 
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* 개별 메시지 말풍선 */
    .msg {
        max-width: 80%;
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 14px;
        line-height: 1.4;
        word-break: break-all;
    }

    /* 상대방 메시지 (왼쪽) */
    .msg.other {
        align-self: flex-start;
        background: #23273a;
        color: var(--ink);
        border-top-left-radius: 0;
    }
    /* 상대방 이름 작게 표시 */
    .msg-name {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 2px;
        display: block;
    }

    /* 내 메시지 (오른쪽) */
    .msg.me {
        align-self: flex-end;
        background: var(--accent); /* 포인트 컬러 */
        color: #0b0c12; /* 검은 글씨 */
        border-top-right-radius: 0;
        font-weight: 600;
    }

    /* 입력창 스타일 (기존 유지 + 수정) */
    .chat-input-row {
        display: flex;
        gap: 10px;
    }
    .chat-input {
        flex: 1;
        background: #161821;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 14px 16px;
        color: var(--ink);
    }
    .chat-input:focus { outline: 1px solid var(--accent); }
</style>

<div class="chat-wrapper">
    <div class="chat-box" id="chat-box">
        <div style="text-align:center; color:gray; font-size:12px; margin-top:10px;">
            채팅 입장
        </div>
    </div>

    <div class="chat-input-row">
        <input type="text" id="chat-input" class="chat-input" 
               placeholder="메시지를 입력하고 엔터를 누르세요" autocomplete="off" />
    </div>
</div>
{% endblock %}