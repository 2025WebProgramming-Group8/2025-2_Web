{% extends 'base.html' %} 
{% block title %}íƒ€ì´ë¨¸{% endblock %}

{% block top_area %}
    <div class="topbar" style="max-width:1100px;margin:16px auto 0;padding:0 20px">
        <div class="btn" aria-label="ë’¤ë¡œ">â†</div>
        <div class="room" aria-label="ìŠ¤í„°ë””ë£¸ ì´ë¦„">{{ study.name }}</div>
        <div class="btn" aria-label="í™ˆ">í™ˆ</div>
    </div> 
{% endblock %}

{% block header_content %}
    {% endblock %}

{% block content %}
  <style>
    :root{ --bg:#0e0f13; --panel:#161821; --ink:#e9eaf3; --muted:#a4a7b8; --line:#232637; --accent:#93b2ff; --ok:#79e08f; --warn:#fbc531; --err:#ff6b6b; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; }
    a{ color:inherit; text-decoration:none }

    /* Layout */
    .wrap{ max-width:1100px; margin:24px auto; padding:0 20px; display:grid; grid-template-columns: 1fr 320px; gap:16px }
    .panel{ background:#1b1e2a; border:1px solid var(--line); border-radius:14px; padding:14px }

    /* Top bar */
    .topbar{ display:grid; grid-template-columns:80px 1fr 80px; gap:10px; margin-bottom:12px }
    .btn{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:10px 12px; text-align:center; cursor:default }
    .room{ background:#161821; border:1px solid var(--line); border-radius:10px; padding:10px 12px; text-align:center; font-weight:800 }

    /* Left  */
    .left{ display:grid; gap:16px }
    .char{ height:220px; display:grid; place-items:center; color:var(--muted); border-radius:12px; border:1px dashed #2a2f47 }

    .members{ display:grid; gap:10px }
    .row{ display:grid; grid-template-columns: 110px 70px 100px 60px 80px; gap:10px; align-items:center }
    .pill{ background:#23273a; border:1px solid var(--line); border-radius:999px; padding:8px 10px; text-align:center; font-weight:800 }
    .state.on{ background:#14361d; border-color:#1f6f38; color:#b9ffd0 }
    .state.off{ background:#3a1918; border-color:#7a2a26; color:#ffd1cc }
    .state.rest{ background:#3a3314; border-color:#7a6a1f; color:#fff0b3 }
    .timebox, .lvl{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:8px 10px; text-align:center }
    .avatar{ width:34px; height:34px; border-radius:999px; background:#2a2f47; border:1px solid var(--line) }

    /* Right */
    .timer{ display:grid; gap:10px }
    .timer .face{ background:#0f121d; border:1px solid var(--line); border-radius:12px; padding:18px; text-align:center; font-size:40px; font-weight:900; letter-spacing:1px }
    .timer .cta{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:12px; text-align:center; font-weight:800 }

    /* Chat input */
    .chat{ max-width:1100px; margin:0 auto 26px; padding:0 20px }
    .chat input{ width:100%; background:#161821; border:1px solid var(--line); border-radius:12px; padding:14px 16px; color:var(--ink) }

    @media (max-width:950px){ .wrap{ grid-template-columns:1fr } }
  </style>
    <section class="left">
        <div class="panel char">ìºë¦­í„° ì‚¬ì§„ê³¼ ìƒíƒœ</div>

        <div class="panel members" aria-label="ê·¸ë£¹ì› í˜„í™©">
            {% for member in study.members.all %}
        <div class="row" data-user-id="{{ member.id }}">
        <div class="pill">{{ member.profile.nickname|default:member.username }}</div>
        
        <div class="pill state off">OFF</div>
        
        <div class="timebox">
            {{ member.profile.total_study_time|default:"00:00" }}
        </div>
        
        <div class="avatar"></div>
        
        <div class="lvl">Lv. {{ member.profile.level }}</div>
    </div>
    {% endfor %}
</div>
    </section>

    <aside class="panel timer" aria-label="íƒ€ì´ë¨¸">
    <div class="face">00:00</div>
    
    <div class="cta">
        {% if is_member %}
            <span style="cursor:pointer">ê³µë¶€ ì‹œì‘</span>
        {% else %}
            <form action="{% url 'join_study' study.group_code %}" method="post">
                {% csrf_token %}
                <button type="submit" style="background:none; border:none; color:#93b2ff; font-weight:800; font-size:inherit; cursor:pointer;">
                    ìŠ¤í„°ë”” ê°€ì…í•˜ê¸°
                </button>
            </form>
        {% endif %}
    </div>
    </aside>

<script src="http://127.0.0.1:3000/socket.io/socket.io.js"></script> 
<script>
    // 1. ì†Œì¼“ ì—°ê²° ì„¤ì • (Node.js ì„œë²„ ì£¼ì†Œ)
    const socket = io('http://127.0.0.1:3000'); 

    // 2. í˜„ì¬ ì‚¬ìš©ì ë° ìŠ¤í„°ë”” ì •ë³´ (Django í…œí”Œë¦¿ ë³€ìˆ˜ ì‚¬ìš©)
    const myUserId = "{{ request.user.id }}";
    const studyRoomId = "{{ study.id }}"; // 1ë‹¨ê³„ì—ì„œ study ê°ì²´ë¥¼ ì „ë‹¬í–ˆìœ¼ë¯€ë¡œ ì‚¬ìš© ê°€ëŠ¥
    
    // 3. HTML ìš”ì†Œ ì ‘ê·¼
    const timerFace = document.querySelector('.timer .face');
    const ctaButtonSpan = document.querySelector('.timer .cta span');
    const memberRowsContainer = document.querySelector('.members');

    // 4. íƒ€ì´ë¨¸ ìƒíƒœ ë³€ìˆ˜
    let timerInterval = null; 
    let isStudying = false;
    let myCurrentTime = 0; // ì´ˆ ë‹¨ìœ„ë¡œ ëˆ„ì ëœ ê³µë¶€ ì‹œê°„ (DBì—ì„œ ë¶ˆëŸ¬ì˜¨ ì´ˆê¸°ê°’ìœ¼ë¡œ ì„¤ì • í•„ìš”)

    function formatTime(seconds) {
        const m = String(Math.floor(seconds / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        return `${m}:${s}`; 
    }

    // ë¡œì»¬ íƒ€ì´ë¨¸ ì‹œì‘/ì •ì§€ ë¡œì§ (Socket.IO í†µì‹  ì¶”ê°€)
    function startMyTimer() {
        if (isStudying) return; // ì´ë¯¸ ì‹œì‘ëœ ê²½ìš° ë¬´ì‹œ

        isStudying = true;
        ctaButtonSpan.textContent = "ê³µë¶€ ì¤‘ì§€";
        ctaButtonSpan.parentElement.classList.add('cta-studying'); // CSS í´ë˜ìŠ¤ë¡œ ìŠ¤íƒ€ì¼ ë³€ê²½

        // ğŸ“Œ ì„œë²„ì— 'start' ì´ë²¤íŠ¸ ì „ì†¡
        socket.emit('timer_action', { 
            room: studyRoomId, 
            userId: myUserId, 
            action: 'start',
            currentTime: myCurrentTime // í˜„ì¬ ëˆ„ì  ì‹œê°„ë„ í•¨ê»˜ ë³´ëƒ„
        });
        
        // 1ì´ˆë§ˆë‹¤ ì‹œê°„ ê°±ì‹ 
        timerInterval = setInterval(() => {
            myCurrentTime++;
            timerFace.textContent = formatTime(myCurrentTime);
            
            // 1ë¶„(60ì´ˆ)ë§ˆë‹¤ ì„œë²„ì— í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸ (ì¦ì€ í†µì‹  ë°©ì§€)
            if (myCurrentTime % 60 === 0) {
                 // ğŸ“Œ 1ë¶„ë§ˆë‹¤ ì„œë²„ì— í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ì•Œë¦¼ (ì„ íƒ ì‚¬í•­)
                 // socket.emit('update_timer', { room: studyRoomId, userId: myUserId, currentTime: myCurrentTime });
            }
        }, 1000); 
    }

    function stopMyTimer() {
        if (!isStudying) return;

        isStudying = false;
        clearInterval(timerInterval);
        timerInterval = null;
        ctaButtonSpan.textContent = "ê³µë¶€ ì‹œì‘";
        ctaButtonSpan.parentElement.classList.remove('cta-studying');

        // ğŸ“Œ ì„œë²„ì— 'stop' ì´ë²¤íŠ¸ ì „ì†¡
        socket.emit('timer_action', { 
            room: studyRoomId, 
            userId: myUserId, 
            action: 'stop',
            currentTime: myCurrentTime // ìµœì¢… ëˆ„ì  ì‹œê°„ë„ í•¨ê»˜ ë³´ëƒ„
        });
    }

    // 5. ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
    if (ctaButtonSpan) {
        ctaButtonSpan.addEventListener('click', () => {
            if (!isStudying) {
                startMyTimer();
            } else {
                stopMyTimer();
            }
        });
    }

    // 6. ì†Œì¼“ ì—°ê²° ì‹œ ìŠ¤í„°ë””ë£¸ ì…ì¥ ì´ë²¤íŠ¸ ì „ì†¡
    socket.on('connect', () => {
        console.log('Socket.IO ì„œë²„ ì—°ê²°ë¨');
        if (studyRoomId) {
            socket.emit('join_room', studyRoomId); // ë£¸ì— ì…ì¥í•˜ì—¬ í•´ë‹¹ ê·¸ë£¹ ë°ì´í„°ë§Œ ë°›ë„ë¡ ìš”ì²­
        }
    });

    // 7. ì„œë²„ë¡œë¶€í„° ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
    socket.on('status_update', (allUsersStatus) => {
        // allUsersStatus: { userId: { time: N, isStudying: true }, ... }

        // í˜„ì¬ í˜ì´ì§€ì˜ ëª¨ë“  ë©¤ë²„ í–‰ì„ ìˆœíšŒí•˜ë©° ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸
        memberRowsContainer.querySelectorAll('.row').forEach(row => {
            const memberId = row.dataset.userId; 
            const status = allUsersStatus[memberId];
            
            if (!status) return; // í•´ë‹¹ ë©¤ë²„ì˜ ìƒíƒœ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€

            const statusPill = row.querySelector('.state');
            const timeBox = row.querySelector('.timebox');
            
            timeBox.textContent = formatTime(status.time); // ì‹¤ì‹œê°„ ì‹œê°„ ì—…ë°ì´íŠ¸

            if (status.isStudying) {
                statusPill.textContent = "ON";
                statusPill.className = "pill state on";
                
                // ë§Œì•½ ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ìê°€ 'ë‚˜' ìì‹ ì´ë¼ë©´ ë¡œì»¬ ìƒíƒœ ë™ê¸°í™”
                if (memberId === myUserId && !isStudying) {
                    myCurrentTime = status.time;
                    timerFace.textContent = formatTime(myCurrentTime);
                    // (í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í–ˆìœ¼ë‚˜ ë‹¤ë¥¸ ì‚¬ëŒì´ ë‚´ê°€ ê³µë¶€ ì¤‘ì¸ ê²ƒì„ ë³´ê³  ìˆì„ ë•Œ ìƒíƒœ ë³µêµ¬ ë¡œì§)
                }

            } else {
                statusPill.textContent = "OFF";
                statusPill.className = "pill state off";
            }
        });
    });

</script>
{% endblock %}

{% block chat_input %}
    <div class="chat">
        <input type="text" placeholder="ì‹¤ì‹œê°„ ì±„íŒ… ì…ë ¥" aria-label="ì±„íŒ… ì…ë ¥" />
    </div>
{% endblock %}