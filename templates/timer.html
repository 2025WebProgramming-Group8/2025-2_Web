{% extends 'base.html' %} 
{% block title %}타이머{% endblock %}

{% block top_area %}
    <div class="topbar" style="max-width:1100px;margin:16px auto 0;padding:0 20px">
        <div class="btn" aria-label="뒤로">←</div>
        <div class="room" aria-label="스터디룸 이름">{{ study.name }}</div>
        <div class="btn" aria-label="홈">홈</div>
    </div> 
{% endblock %}

{% block header_content %}
    {% endblock %}

{% block content %}
  <style>
    :root{ --bg:#0e0f13; --panel:#161821; --ink:#e9eaf3; --muted:#a4a7b8; --line:#232637; --accent:#93b2ff; --ok:#79e08f; --warn:#fbc531; --err:#ff6b6b; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; }
    a{ color:inherit; text-decoration:none }

    /* Layout */
    .wrap{ max-width:1100px; margin:24px auto; padding:0 20px; display:grid; grid-template-columns: 1fr 320px; gap:16px }
    .panel{ background:#1b1e2a; border:1px solid var(--line); border-radius:14px; padding:14px }

    /* Top bar */
    .topbar{ display:grid; grid-template-columns:80px 1fr 80px; gap:10px; margin-bottom:12px }
    .btn{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:10px 12px; text-align:center; cursor:default }
    .room{ background:#161821; border:1px solid var(--line); border-radius:10px; padding:10px 12px; text-align:center; font-weight:800 }

    /* Left  */
    .left{ display:grid; gap:16px }
    .char{ height:220px; display:grid; place-items:center; color:var(--muted); border-radius:12px; border:1px dashed #2a2f47 }

    .members{ display:grid; gap:10px }
    .row{ display:grid; grid-template-columns: 110px 70px 100px 60px 80px; gap:10px; align-items:center }
    .pill{ background:#23273a; border:1px solid var(--line); border-radius:999px; padding:8px 10px; text-align:center; font-weight:800 }
    .state.on{ background:#14361d; border-color:#1f6f38; color:#b9ffd0 }
    .state.off{ background:#3a1918; border-color:#7a2a26; color:#ffd1cc }
    .state.rest{ background:#3a3314; border-color:#7a6a1f; color:#fff0b3 }
    .timebox, .lvl{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:8px 10px; text-align:center }
    .avatar{ width:34px; height:34px; border-radius:999px; background:#2a2f47; border:1px solid var(--line) }

    /* Right */
    .timer{ display:grid; gap:10px }
    .timer .face{ background:#0f121d; border:1px solid var(--line); border-radius:12px; padding:18px; text-align:center; font-size:40px; font-weight:900; letter-spacing:1px }
    .timer .cta{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:12px; text-align:center; font-weight:800 }

    /* Chat input */
    .chat{ max-width:1100px; margin:0 auto 26px; padding:0 20px }
    .chat input{ width:100%; background:#161821; border:1px solid var(--line); border-radius:12px; padding:14px 16px; color:var(--ink) }

    @media (max-width:950px){ .wrap{ grid-template-columns:1fr } }
  </style>
    <section class="left">
        <div class="panel char">캐릭터 사진과 상태</div>

        <div class="panel members" aria-label="그룹원 현황">
            {% for member_link in groups %} 
            <div class="row" data-user-id="{{ member_link.user.id }}">
                <div class="pill">{{ member_link.user.profile.nickname|default:member_link.user.username }}</div>
                <div class="pill state off">OFF</div>
                
                <div class="timebox">
                    {{ member_link.group_study_time|default:"0:00:00" }}
                </div>
                
                <div class="avatar"></div>
                <div class="lvl">Lv. {{ member_link.user.profile.level }}</div>
            </div>
            {% endfor %}
        </div>
    </section>

    <aside class="panel timer" aria-label="타이머">
    <div class="face">0:00:00</div>
    
    <div class="cta">
        {% if is_member %}
            <span style="cursor:pointer">공부 시작</span>
        {% else %}
            <form action="{% url 'join_study' study.group_code %}" method="post">
                {% csrf_token %}
                <button type="submit" style="background:none; border:none; color:#93b2ff; font-weight:800; font-size:inherit; cursor:pointer;">
                    스터디 가입하기
                </button>
            </form>
        {% endif %}
        </div>
    </aside>

<script src="http://127.0.0.1:3000/socket.io/socket.io.js"></script> 
<script>
    // 1. 소켓 연결 설정 (Node.js 서버 주소)
    const socket = io('http://127.0.0.1:3000'); 

    // 2. 현재 사용자 및 스터디 정보 (Django 템플릿 변수 사용)
    const myUserId = String("{{ request.user.id }}");
    const studyRoomId = "{{ study.id }}";
    
    // 3. HTML 요소 접근
    const timerFace = document.querySelector('.timer .face');
    const ctaButtonContainer = document.querySelector('.timer .cta');
    const ctaButtonSpan = ctaButtonContainer ? ctaButtonContainer.querySelector('span') : null;
    const memberRowsContainer = document.querySelector('.members');

    // 4. 타이머 상태 변수
    const initialTimeString = "{{ initial_time|default:'0' }}"; 
    let parsedTime = parseInt(initialTimeString, 10);
    let initialTimeFromDB = isNaN(parsedTime) ? 0 : parsedTime;
    let myCurrentTime = initialTimeFromDB; // DB에서 가져온 시간부터 시작
    let timerInterval = null; 
    let isStudying = false;

    function formatTime(seconds) {
        const h = String(Math.floor(seconds / 3600)); 
        const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    // 페이지 로드 시 타이머 UI를 DB 시간으로 초기화합니다.
    timerFace.textContent = formatTime(myCurrentTime);

    // 로컬 타이머 시작/정지 로직 (Socket.IO 통신 추가)
    function startMyTimer() {
        if (isStudying) return; // 이미 시작된 경우 무시
        isStudying = true;
        ctaButtonSpan.textContent = "공부 중지";
        ctaButtonSpan.parentElement.classList.add('cta-studying');
        // 서버에 'start' 이벤트 전송
        socket.emit('timer_action', { 
            room: studyRoomId, 
            userId: myUserId, 
            action: 'start',
            currentTime: myCurrentTime // 현재 누적 시간도 함께 보냄
        });
        
        // 1초마다 시간 갱신
        timerInterval = setInterval(() => {
            myCurrentTime++;
            timerFace.textContent = formatTime(myCurrentTime);
        }, 1000);
    }

    function stopMyTimer() {
        if (!isStudying) return;

        // 서버에 'stop' 이벤트 전송
        socket.emit('timer_action', { 
            room: studyRoomId, 
            userId: myUserId, 
            action: 'stop',
            currentTime: myCurrentTime // 최종 누적 시간도 함께 보냄
        });
         clearInterval(timerInterval);
        timerInterval = null;
        isStudying = false;

        ctaButtonSpan.textContent = "공부 시작";
        ctaButtonSpan.parentElement.classList.remove('cta-studying');

        console.log("STOP 이벤트 즉시 전송 완료. DB 저장 요청됨.");

        window.location.reload();
    }

    // 5. 버튼 클릭 이벤트 연결
    if (ctaButtonContainer && ctaButtonSpan) {
        ctaButtonContainer.addEventListener('click', () => {
            if (!isStudying) {
                startMyTimer();
            } else {
                stopMyTimer();
            }
        });
    }

    // 6. 소켓 연결 시 스터디룸 입장 이벤트 전송
    socket.on('connect', () => {
        console.log('Socket.IO 서버 연결됨');
        if (studyRoomId && myUserId && myUserId !== 'None' && myUserId !== '') { 
            socket.emit('join_room', { roomId: studyRoomId, userId: myUserId });
    }
    });

    // 7. 서버로부터 실시간 상태 업데이트 수신
    socket.on('status_update', (allUsersStatus) => {
    
        const myUserIdString = String(myUserId);
        // myStatus는 루프 내부에서만 사용해도 되지만, 여기서는 전체 상태 파악을 위해 남겨둠.
        const myStatus = allUsersStatus[myUserIdString]; 

        // 다른 멤버 UI 업데이트
        memberRowsContainer.querySelectorAll('.row').forEach(row => {
            const memberId = String(row.dataset.userId); 
            const status = allUsersStatus[memberId];
            
            // 데이터가 없으면 (다른 방 멤버) 업데이트 중단
            if (!status) return; 

            const statusPill = row.querySelector('.state');
            const timeBox = row.querySelector('.timebox');
            
            // NaN 방지 및 시간 값 변환 (핵심)
            const currentStatusTime = parseInt(status.time, 10);
            if (isNaN(currentStatusTime)) return; // 숫자가 아니면 렌더링 중단

            // 시간 UI 업데이트 (모든 멤버)
            timeBox.textContent = formatTime(currentStatusTime);

            if (status.isStudying) {
                // ON 상태 업데이트 (모든 멤버에게 적용)
                statusPill.textContent = "ON";
                statusPill.classList.remove('off', 'rest'); 
                statusPill.classList.add('on'); 
                
                if (memberId === myUserIdString) {
                    // 본인 상태 동기화 (로컬 변수 및 메인 타이머)
                    isStudying = true;
                    if (currentStatusTime >= myCurrentTime) {
                        myCurrentTime = currentStatusTime; 
                        timerFace.textContent = formatTime(myCurrentTime);
                    }
                }
            } else {
                // OFF 상태 업데이트 (모든 멤버에게 적용)
                statusPill.textContent = "OFF";
                statusPill.classList.remove('on', 'rest');
                statusPill.classList.add('off');
                
                if (memberId === myUserIdString) {
                    // 본인 상태 동기화
                    isStudying = false;
                    myCurrentTime = currentStatusTime;
                    timerFace.textContent = formatTime(myCurrentTime);
                }
            }
    });

    // 내 로컬 타이머 제어 (오직 myStatus만 사용)
    if (myStatus) {
        // 서버 시간이 내 로컬 시간보다 크거나 같을 때만 동기화하여 시간 역행 방지
        if (myStatus.time >= myCurrentTime) {
            myCurrentTime = myStatus.time; 
            timerFace.textContent = formatTime(myCurrentTime);
        }
        
        // myStatus.isStudying에 따라 로컬 UI와 상태를 최종적으로 확인 (선택 사항)
    }
});
</script>
{% endblock %}

{% block chat_input %}
    <div class="chat">
        <input type="text" placeholder="실시간 채팅 입력" aria-label="채팅 입력" />
    </div>
{% endblock %}