{% extends 'base.html' %} 
{% load static %} 
{% block title %}íƒ€ì´ë¨¸{% endblock %}

{% block top_area %}
<div class="topbar" style="max-width:1100px;margin:16px auto 0;padding:0 20px">
    <a href="{% url 'board' %}" class="btn" aria-label="ë’¤ë¡œ" onclick="if (history.length > 1) { history.back(); return false; }">â†</a>
    <div class="room" aria-label="ìŠ¤í„°ë””ë£¸ ì´ë¦„">{{ study.name }}</div>
    <a href="{% url 'board' %}" class="btn" aria-label="í™ˆ">í™ˆ</a>
</div>
{% endblock %}

{% block header_content %}{% endblock %}

{% block content %}
<style>
    /* Top bar ë ˆì´ì•„ì›ƒ */
    .topbar { 
        display: grid; 
        grid-template-columns: 80px 1fr 80px; /* ì¢Œì¸¡ë²„íŠ¼ - ì œëª© - ìš°ì¸¡ë²„íŠ¼ ë¹„ìœ¨ */
        gap: 10px; 
        margin-bottom: 12px; 
    }
    
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë’¤ë¡œê°€ê¸°, í™ˆ) */
    .btn { 
        background: #1b1e29; 
        border: 1px solid var(--line); 
        border-radius: 10px; 
        padding: 10px 12px; 
        text-align: center; 
        cursor: pointer; 
        color: var(--ink); /* ê¸€ììƒ‰ */
        display: flex; /* ê¸€ì ì¤‘ì•™ ì •ë ¬ */
        align-items: center;
        justify-content: center;
    }
    
    /* ë°© ì´ë¦„ ìŠ¤íƒ€ì¼ */
    .room { 
        background: #161821; 
        border: 1px solid var(--line); 
        border-radius: 10px; 
        padding: 10px 12px; 
        text-align: center; 
        font-weight: 800; 
        color: var(--ink);
    }
    /* ê¸°ë³¸ ë³€ìˆ˜ */
    :root{ --bg:#0e0f13; --panel:#161821; --ink:#e9eaf3; --muted:#a4a7b8; --line:#232637; --accent:#93b2ff; --ok:#79e08f; --warn:#fbc531; --err:#ff6b6b; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; }
    a{ color:inherit; text-decoration:none }

    /* ë ˆì´ì•„ì›ƒ */
    .wrap{ max-width:1100px; margin:24px auto; padding:0 20px; display:grid; grid-template-columns: 1fr 320px; gap:16px }
    .panel{ background:#1b1e2a; border:1px solid var(--line); border-radius:14px; padding:14px }
    .left{ display:grid; gap:16px }
    .panel.char { display: flex; flex-direction: column; align-items: center; justify-content: center; }

    /* ğŸ  ê³ ì–‘ì´ ë°© */
    .cat-room {
        width: 100%; height: 220px; position: relative;
        background-color: #2a2328; 
        overflow: hidden; border-radius: 12px; border: 1px solid var(--line);
        /* ë°”ë‹¥ íŒ¨í„´ */
        background-image: linear-gradient(to bottom, #3d3138 40px, transparent 40px);
    }

    /* ğŸª‘ ê°€êµ¬ */
    .prop {
        width: 32px; height: 32px;
        image-rendering: pixelated;
        background-image: url("{% static 'img/room_tiles.png' %}");
        background-repeat: no-repeat;
        transform: scale(2); transform-origin: top left;
        position: absolute; z-index: 1;
    }
    .prop-shelf { width:32px; height:64px; background-position: -32px -32px; }
    .prop-plant { width:32px; height:32px; background-position: -224px -64px; }

    /* ğŸ± ê³ ì–‘ì´ (32px ê·¸ë¦¬ë“œ ì™„ë²½ ì ìš©) */
    .sprite-cat {
        /* 1. ì›ë³¸ í¬ê¸°ì¸ 32pxë¡œ ê³ ì • */
        width: 32px; 
        height: 32px;
        
        /* 2. í™”ë©´ì—ì„œ 2ë°°ë¡œ ë»¥íŠ€ê¸° (64px íš¨ê³¼) */
        transform: scale(2); 
        transform-origin: bottom center;

        image-rendering: pixelated; 
        background-repeat: no-repeat;
        
        /* 3. ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸° ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì¢Œí‘œ ì˜¤ì°¨ 0%) */
        background-size: auto; 
        
        position: absolute;
        /* ë””ë²„ê¹…ìš© í…Œë‘ë¦¬ (í™•ì¸ í›„ ì‚­ì œ) */
        /* border: 1px solid rgba(255,0,0,0.5); */
    }

    /* ìŠ¤í‚¨ */
    .skin-1 { background-image: url("{% static 'img/sprite_cat (1).png' %}"); }
    .skin-2 { background-image: url("{% static 'img/sprite_cat (2).png' %}"); }
    .skin-3 { background-image: url("{% static 'img/sprite_cat (3).png' %}"); }
    .skin-4 { background-image: url("{% static 'img/sprite_cat (4).png' %}"); }
    .skin-5 { background-image: url("{% static 'img/sprite_cat (5).png' %}"); }
    .skin-6 { background-image: url("{% static 'img/sprite_cat (6).png' %}"); }

    /* ğŸ¬ ë™ì‘ (32px ë‹¨ìœ„ ì •í™•í•œ ì¢Œí‘œ) */
    /* Yì¶•: 32px (ì²« ë²ˆì§¸ ì¤„, Së°©í–¥) */

    /* 1. ì•‰ê¸° (Sit) */
    .pose-sit {
        /* X: 0px (ì²« ë²ˆì§¸ ì¹¸) */
        background-position: 0px -32px; 
        animation: bounce 2s infinite;
        left: 50%; bottom: 50px; z-index: 10;
    }

    /* 2. ëˆ•ê¸° (Lay) */
    .pose-lay {
        /* X: -256px (9ë²ˆì§¸ ì¹¸ = 32 * 8) */
        background-position: -256px -32px; 
        left: 20%; bottom: 40px; z-index: 5;
    }

    /* 3. ê±·ê¸° (Walk) */
    .pose-walk {
        /* ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì œì–´ */
        animation: walk-anim 0.8s steps(4) infinite; 
        left: 75%; bottom: 45px; z-index: 5;
    }

    /* 4. ë‹¬ë¦¬ê¸° (Run) */
    .pose-run {
        animation: run-anim 0.6s steps(4) infinite, move-across 8s linear infinite;
        bottom: 60px; z-index: 2;
    }

    /* --- ğŸ”„ ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ (ì •í™•í•œ 128px ì´ë™) --- */
    
    /* ê±·ê¸°: X = -384px ~ -512px (13~16ë²ˆì§¸ ì¹¸) */
    @keyframes walk-anim {
        from { background-position: -384px -32px; } 
        to { background-position: -512px -32px; }   
    }

    /* ë‹¬ë¦¬ê¸°: X = -512px ~ -640px (17~20ë²ˆì§¸ ì¹¸) */
    @keyframes run-anim {
        from { background-position: -512px -32px; } 
        to { background-position: -640px -32px; }   
    }

    /* ì´ë™ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes move-across {
        0% { left: -50px; transform: scale(2) scaleX(1); }
        45% { left: 110%; transform: scale(2) scaleX(1); }
        50% { left: 110%; transform: scale(2) scaleX(-1); } 
        95% { left: -50px; transform: scale(2) scaleX(-1); }
        100% { left: -50px; transform: scale(2) scaleX(1); }
    }
    @keyframes bounce { 
        0%, 100% { transform: scale(2) translateY(0); } 
        50% { transform: scale(2) translateY(-2px); } 
    }

    /* ë§í’ì„  */
    .cat-bubble {
        position: absolute; top: -15px; left: 50%; transform: translateX(-50%) scale(0.5);
        background: rgba(255,255,255,0.9); color: black; padding: 4px 8px; border-radius: 8px;
        font-size: 10px; font-weight: bold; opacity: 0; transition: opacity 0.2s; pointer-events: none; white-space: nowrap;
    }
    .sprite-cat:hover .cat-bubble { opacity: 1; top: -25px; }

    /* ê¸°íƒ€ UI */
    .topbar .btn {cursor: pointer;}
    .cat-status { display:flex; gap:8px; align-items:center; font-size:14px; color:var(--muted); }
    .cat-badge { background:var(--accent); color:#0b0c12; font-weight:800; padding:4px 8px; border-radius:6px; font-size:12px; }
    .members{ display:grid; gap:10px }
    .row{ display:grid; grid-template-columns: 110px 70px 100px 60px 80px; gap:10px; align-items:center }
    .pill{ background:#23273a; border:1px solid var(--line); border-radius:999px; padding:8px 10px; text-align:center; font-weight:800 }
    .state.on{ background:#14361d; border-color:#1f6f38; color:#b9ffd0 }
    .state.off{ background:#3a1918; border-color:#7a2a26; color:#ffd1cc }
    .timebox, .lvl{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:8px 10px; text-align:center }
    .avatar{ width:34px; height:34px; border-radius:999px; background:#2a2f47; border:1px solid var(--line) }
    .timer{ display:grid; gap:10px }
    .timer .face{ background:#0f121d; border:1px solid var(--line); border-radius:12px; padding:18px; text-align:center; font-size:40px; font-weight:900; letter-spacing:1px }
    .timer .cta{ background:#1b1e29; border:1px solid var(--line); border-radius:10px; padding:12px; text-align:center; font-weight:800 }
    .chat-wrapper { max-width: 1100px; margin: 0 auto 26px; padding: 0 20px; display: flex; flex-direction: column; gap: 10px; }
    .chat-box { height: 350px; background: #161821; border: 1px solid var(--line); border-radius: 12px; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .msg { max-width: 80%; padding: 8px 12px; border-radius: 10px; font-size: 14px; line-height: 1.4; word-break: break-all; }
    .msg.other { align-self: flex-start; background: #23273a; color: var(--ink); border-top-left-radius: 0; }
    .msg-name { font-size: 11px; color: var(--muted); margin-bottom: 2px; display: block; }
    .msg.me { align-self: flex-end; background: var(--accent); color: #0b0c12; border-top-right-radius: 0; font-weight: 600; }
    .chat-input-row { display: flex; gap: 10px; }
    .chat-input { flex: 1; background: #161821; border: 1px solid var(--line); border-radius: 12px; padding: 14px 16px; color: var(--ink); }
    .chat-input:focus { outline: 1px solid var(--accent); }
    /* ğŸ’¬ ì±„íŒ…ì°½ í”„ë¡œí•„ ë””ìì¸ (ì¶”ê°€ë¨) */
    .msg-row {
        display: flex;
        align-items: flex-end; /* ë©”ì‹œì§€ í•˜ë‹¨ì— ì‚¬ì§„ ì •ë ¬ */
        gap: 8px;
        margin-bottom: 4px;
    }
    
    /* ìƒëŒ€ë°©: ì‚¬ì§„ ì™¼ìª½, ë©”ì‹œì§€ ì˜¤ë¥¸ìª½ */
    .msg-row.other {
        flex-direction: row;
    }
    
    /* ë‚˜: ë©”ì‹œì§€ ì˜¤ë¥¸ìª½, ì‚¬ì§„ ì—†ìŒ (ë³´í†µ ë‚´ í”„ì‚¬ëŠ” ì•ˆ ë³´ì—¬ì¤Œ) */
    .msg-row.me {
        flex-direction: row-reverse;
    }

    /* í”„ë¡œí•„ ì‚¬ì§„ ìŠ¤íƒ€ì¼ */
    .chat-profile-img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #23273a;
        border: 1px solid var(--line);
        object-fit: cover; /* ì´ë¯¸ì§€ ì°Œê·¸ëŸ¬ì§ ë°©ì§€ */
        flex-shrink: 0; /*ê³µê°„ ë¶€ì¡±í•´ë„ ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
    }

    /* ë§í’ì„  ê¼¬ë¦¬ ë‹¤ë“¬ê¸° */
    .msg { max-width: 75%; } /* ì‚¬ì§„ ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ ë„ˆë¹„ ì¡°ì • */
    @media (max-width:950px){ .wrap{ grid-template-columns:1fr } }
</style>

<section class="left">
    <div class="panel char">
        <div class="cat-room" id="cat-room">
            <div class="prop prop-shelf" style="left: 10%; top: 40px;"></div>
            <div class="prop prop-plant" style="right: 15%; top: 100px;"></div>
        </div>
        
        <div class="cat-status" style="margin-top: 10px;">
            <span class="cat-badge">Lv. {{ request.user.profile.level }}</span>
            <span id="cat-message">ê°€ì¡±ì„ ëª¨ì•„ë³´ì„¸ìš”!</span>
        </div>
    </div>  

    <div class="panel notice-board" style="padding: 15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 style="margin:0; font-size:16px; font-weight:800; color:var(--ink);">ê³µì§€ì‚¬í•­</h3>
            {% if is_creator %}
                <button onclick="toggleNoticeForm()" style="background:none; border:none; color:var(--muted); cursor:pointer; font-size:12px;">[ìˆ˜ì •]</button>
            {% endif %}
        </div>

        <div id="notice-content" style="background:#23273a; padding:10px; border-radius:8px; font-size:14px; line-height:1.4; color:var(--ink); white-space: pre-wrap; min-height: 40px;">{{ study.notice }}</div>

        {% if is_creator %}
        <form id="notice-form" action="{% url 'update_notice' study.group_code %}" method="post" style="display:none; margin-top:10px;">
            {% csrf_token %}
            <textarea name="notice" style="width:100%; height:80px; background:#161821; color:var(--ink); border:1px solid var(--line); border-radius:8px; padding:8px; resize:vertical;">{{ study.notice }}</textarea>
            <div style="text-align:right; margin-top:5px;">
                <button type="button" onclick="toggleNoticeForm()" style="background:#3a1918; border:1px solid var(--line); color:#ff6b6b; padding:4px 8px; border-radius:6px; cursor:pointer;">ì·¨ì†Œ</button>
                <button type="submit" style="background:var(--accent); border:none; color:#0b0c12; padding:4px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">ì €ì¥</button>
            </div>
        </form>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--line); text-align: right;">
            <form action="{% url 'delete_study' study.group_code %}" method="post" onsubmit="return confirm('ì •ë§ ìŠ¤í„°ë””ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? \nëª¨ë“  ë©¤ë²„ì™€ ê¸°ë¡ì´ ì‚¬ë¼ì§€ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
                {% csrf_token %}
                <button type="submit" style="background: #3a1918; color: #ff6b6b; border: 1px solid #7a2a26; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">
                    ìŠ¤í„°ë”” ì‚­ì œ
                </button>
            </form>
        </div>

        <script>
            function toggleNoticeForm() {
                const content = document.getElementById('notice-content');
                const form = document.getElementById('notice-form');
                if (form.style.display === 'none') {
                    form.style.display = 'block';
                    content.style.display = 'none';
                } else {
                    form.style.display = 'none';
                    content.style.display = 'block';
                }
            }
        </script>
        {% endif %}
    </div>

    <div class="panel members" aria-label="ê·¸ë£¹ì› í˜„í™©">
        {% for member_link in groups %} 
        <div class="row" data-user-id="{{ member_link.user.id }}">
            <div class="pill" style="display:flex; align-items:center; gap:4px;">
                {% if member_link.user == study.creator %}
                    <span title="ë°©ì¥">ë°©ì¥</span>
                {% endif %}
                {{ member_link.user.profile.nickname|default:member_link.user.username }}
            </div>
            <div class="pill state off">OFF</div>
            <div class="timebox">{{ member_link.group_study_time|default:"0:00:00" }}</div>
            <div class="avatar"></div>
            <div class="lvl">Lv. {{ member_link.user.profile.level }}</div>
        </div>
        {% endfor %}
    </div>
</section>

<aside class="panel timer" aria-label="íƒ€ì´ë¨¸">
    <div class="face">0:00:00</div>
    <div class="cta">
        {% if is_member %}
            <span style="cursor:pointer">ê³µë¶€ ì‹œì‘</span>
        {% else %}
            <form action="{% url 'join_study' study.group_code %}" method="post">
                {% csrf_token %}
                <button type="submit" style="background:none; border:none; color:#93b2ff; font-weight:800; font-size:inherit; cursor:pointer;">ìŠ¤í„°ë”” ê°€ì…í•˜ê¸°</button>
            </form>
        {% endif %}
    </div>
</aside>

<script src="http://127.0.0.1:3000/socket.io/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const socket = io('http://127.0.0.1:3000');
    const myUserId = String("{{ request.user.id }}");
    const myNickname = "{{ request.user.profile.nickname|default:request.user.username }}";
    const studyRoomId = "{{ study.id }}";
    const myAvatarIndex = "{{ request.user.profile.avatar_index|default:1 }}";

    let myLevel = parseInt("{{ request.user.profile.level|default:1 }}", 10);
    
    const catRoom = document.getElementById('cat-room');
    const catMessage = document.getElementById('cat-message');
    const catBadge = document.querySelector('.cat-badge');
    const skins = ['skin-1', 'skin-2', 'skin-3', 'skin-4', 'skin-5', 'skin-6'];
    const poses = ['pose-sit', 'pose-lay', 'pose-walk', 'pose-run'];

    function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function getRandomSkin() { return skins[randomInt(0, skins.length - 1)]; }

    // ğŸ± ê³ ì–‘ì´ ìƒì„± í•¨ìˆ˜
    function spawnCat(isMain = false) {
        const cat = document.createElement('div');
        
        // ìŠ¤í‚¨/í¬ì¦ˆ ëœë¤ (ë©”ì¸ì€ ê¸°ë³¸ ìŠ¤í‚¨/ì•‰ê¸° ê³ ì •)
        const skin = isMain ? 'skin-1' : getRandomSkin();
        const pose = isMain ? 'pose-sit' : poses[randomInt(0, poses.length - 1)];
        
        cat.className = `sprite-cat ${skin} ${pose}`;

        // ëœë¤ ìœ„ì¹˜ ë°°ì¹˜ (ë‹¨, ë©”ì¸ ê³ ì–‘ì´ëŠ” CSSì—ì„œ ì¤‘ì•™ ì •ë ¬í•˜ë¯€ë¡œ style.left ì•ˆ ì¤Œ)
        if (!isMain) {
            // pose-runì€ í™”ë©´ì„ ê°€ë¡œì§€ë¥´ë¯€ë¡œ left ì„¤ì • ë¶ˆí•„ìš” (ì• ë‹ˆë©”ì´ì…˜ì´ ì œì–´)
            if (pose !== 'pose-run') {
                cat.style.left = randomInt(5, 85) + '%';
                cat.style.bottom = randomInt(20, 80) + 'px';
                cat.style.zIndex = 100 - parseInt(cat.style.bottom); // ì›ê·¼ê°
            }
            
            // ëœë¤ ë°©í–¥ (ì¢Œìš° ë°˜ì „)
            if (Math.random() > 0.5) {
                cat.style.transform = "scale(2) scaleX(-1)"; 
            }
        }

        // ë§í’ì„ 
        const bubble = document.createElement('div');
        bubble.className = 'cat-bubble';
        bubble.innerText = isMain ? "ë‚˜" : "ëƒ¥!";
        if (cat.style.transform.includes("scaleX(-1)")) {
            bubble.style.transform = "translateX(50%) scaleX(-1) scale(0.5)"; 
        }
        cat.appendChild(bubble);

        catRoom.appendChild(cat);
    }

    function updateCatFamily(level) {
        // ê¸°ì¡´ ê³ ì–‘ì´ ì œê±° (ê°€êµ¬(.prop)ëŠ” ë‚¨ê¹€)
        const oldCats = catRoom.querySelectorAll('.sprite-cat');
        oldCats.forEach(c => c.remove());

        // 1. ë‚˜ (Main)
        spawnCat(true);

        // 2. ì¹œêµ¬ë“¤ (ë ˆë²¨ì— ë”°ë¼ ì¶”ê°€, ìµœëŒ€ 20ë§ˆë¦¬)
        const friendCount = Math.min(Math.floor(level / 2), 20);
        for (let i = 0; i < friendCount; i++) {
            spawnCat(false);
        }

        if (catMessage) catMessage.innerText = `ì´ ${friendCount + 1}ë§ˆë¦¬ì˜ ê°€ì¡±!`;
        if (catBadge) catBadge.innerText = "Lv. " + level;
    }

    updateCatFamily(myLevel);

    // --- (ì•„ë˜ ê¸°ì¡´ ë¡œì§ ë™ì¼) ---
    const timerFace = document.querySelector('.timer .face');
    const ctaButtonContainer = document.querySelector('.timer .cta');
    const ctaButtonSpan = ctaButtonContainer ? ctaButtonContainer.querySelector('span') : null;
    const memberRowsContainer = document.querySelector('.members');
    const chatInput = document.getElementById('chat-input');
    const chatBox = document.getElementById('chat-box');

    let myCurrentTime = parseInt("{{ initial_time|default:'0' }}", 10);
    if (isNaN(myCurrentTime)) myCurrentTime = 0;
    let timerInterval = null;
    let isStudying = false;

    function formatTime(seconds) {
        const h = String(Math.floor(seconds / 3600));
        const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        return `${h}:${m}:${s}`;
    }
    timerFace.textContent = formatTime(myCurrentTime);

    function updateTimerUI(studying) {
        isStudying = studying;
        if (isStudying) {
            if (ctaButtonSpan) ctaButtonSpan.textContent = "ê³µë¶€ ì¤‘ì§€";
            if (ctaButtonContainer) ctaButtonContainer.classList.add('cta-studying');
            if (!timerInterval) {
                timerInterval = setInterval(() => {
                    myCurrentTime++;
                    timerFace.textContent = formatTime(myCurrentTime);
                }, 1000);
            }
        } else {
            if (ctaButtonSpan) ctaButtonSpan.textContent = "ê³µë¶€ ì‹œì‘";
            if (ctaButtonContainer) ctaButtonContainer.classList.remove('cta-studying');
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
    }

    if (ctaButtonContainer && ctaButtonSpan) {
        ctaButtonContainer.addEventListener('click', () => {
            const action = isStudying ? 'stop' : 'start';
            socket.emit('timer_action', { room: studyRoomId, userId: myUserId, action: action, currentTime: myCurrentTime });
            updateTimerUI(!isStudying);
        });
    }

    if (chatInput) {
        chatInput.addEventListener('keydown', (e) => {
            if (e.isComposing) return;
            if (e.key === 'Enter') {
                const msg = chatInput.value.trim();
                if (!msg) return;
                socket.emit('chat_message', { room: studyRoomId, nickname: myNickname, message: msg, userId: myUserId, avatar: myAvatarIndex});
                chatInput.value = ''; 
            }
        });
    }

    socket.on('connect', () => {
        if (studyRoomId && myUserId && myUserId !== 'None') {
            socket.emit('join_room', { roomId: studyRoomId, userId: myUserId });
        }
    });

    socket.on('status_update', (allUsersStatus) => {
        const myUserIdString = String(myUserId);
        const myStatus = allUsersStatus[myUserIdString];

        if (myStatus) {
            if (myStatus.time > myCurrentTime) {
                myCurrentTime = myStatus.time;
                timerFace.textContent = formatTime(myCurrentTime);
            }
            if (isStudying !== myStatus.isStudying) {
                updateTimerUI(myStatus.isStudying);
            }
            
            const calculatedLevel = Math.floor(myCurrentTime / 300) + 1;
            if (calculatedLevel > myLevel) {
                myLevel = calculatedLevel; 
                updateCatFamily(myLevel);
            }
        }

        memberRowsContainer.querySelectorAll('.row').forEach(row => {
            const memberId = String(row.dataset.userId);
            const status = allUsersStatus[memberId];
            if (!status) return;

            const statusPill = row.querySelector('.state');
            const timeBox = row.querySelector('.timebox');
            const lvlBox = row.querySelector('.lvl');

            if (status.time) {
                timeBox.textContent = formatTime(status.time);
                const otherLevel = Math.floor(status.time / 300) + 1;
                if(lvlBox) lvlBox.textContent = "Lv. " + otherLevel;
            }

            statusPill.classList.remove('on', 'off');
            if (status.isStudying) {
                statusPill.textContent = "ON";
                statusPill.classList.add('on');
            } else {
                statusPill.textContent = "OFF";
                statusPill.classList.add('off');
            }
        });
    });

    // ì±„íŒ… ìˆ˜ì‹  (í”„ë¡œí•„ ì‚¬ì§„ ì¶”ê°€ë¨)
    socket.on('new_chat', (data) => {
        // 1. ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ì¤„(Row) ìƒì„±
        const row = document.createElement('div');
        
        // 2. ë‚´ê°€ ë³´ë‚¸ ê±´ì§€ í™•ì¸
        const isMe = (String(data.userId) === String(myUserId));
        row.className = isMe ? 'msg-row me' : 'msg-row other';

        // 3. ìƒëŒ€ë°©ì¼ ê²½ìš°ì—ë§Œ í”„ë¡œí•„ ì‚¬ì§„ ì¶”ê°€
        if (!isMe) {
            const img = document.createElement('img');
            // ì•„ë°”íƒ€ ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 1
            const avatarNum = data.avatar || 1;
            // static ê²½ë¡œ ì„¤ì • (Django í…œí”Œë¦¿ ë¬¸ë²•ê³¼ JS ê²°í•©)
            img.src = "{% static 'img/cat_' %}" + avatarNum + ".png";
            img.className = 'chat-profile-img';
            row.appendChild(img);
        }

        // 4. ë§í’ì„  ìƒì„±
        const bubble = document.createElement('div');
        bubble.className = isMe ? 'msg me' : 'msg other';
        
        if (!isMe) {
            // ìƒëŒ€ë°©ì€ ë‹‰ë„¤ì„ë„ í‘œì‹œ
            bubble.innerHTML = `<span class="msg-name">${data.nickname}</span>${data.message}`;
        } else {
            bubble.textContent = data.message;
        }

        row.appendChild(bubble);

        // 5. ì±„íŒ…ì°½ì— ì¶”ê°€
        chatBox.appendChild(row);
        chatBox.scrollTop = chatBox.scrollHeight;
    });
});
</script>
{% endblock %}

{% block chat_input %}
<div class="chat-wrapper">
    <div class="chat-box" id="chat-box">
        <div style="text-align:center; color:gray; font-size:12px; margin-top:10px;">
            ì±„íŒ… ì…ì¥
        </div>
    </div>

    <div class="chat-input-row">
        <input type="text" id="chat-input" class="chat-input" 
                 placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”" autocomplete="off" />
    </div>
</div>
{% endblock %}