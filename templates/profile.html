{% extends 'base.html' %}
{% load static %}
{% block title %}í”„ë¡œí•„{% endblock %}

{% block header_content %}
<header class="head">
  <h1 class="title">ë‚´ ì •ë³´</h1>
</header>
{% endblock %}

{% block content %}
<style>
  :root{
    --bg:#0e0f13;
    --panel:#161821;
    --ink:#e9eaf3;
    --muted:#a4a7b8;
    --line:#232637;
    --accent:#93b2ff;
    --card:#1b1e2a;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
  }
  a{ color:inherit; text-decoration:none; }

  .head{
    max-width:1100px;
    margin:32px auto 16px;
    padding:0 20px;
  }
  .title{
    font-size:28px;
    font-weight:900;
    margin:0 0 10px;
  }

  .wrap{
    max-width:1100px;
    margin:16px auto 40px;
    padding:0 20px;
    display:grid;
    grid-template-columns:360px 700px;
    gap:16px;
  }

  .panel{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px;
    min-height:630px;
  }

  /* LEFT: PROFILE */
  .profile{
    display:grid;
    gap:14px;
    position:relative;
  }

  .avatar{
    width:120px;
    height:120px;
    border-radius:999px;
    border:1px solid var(--line);
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }

  .row{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .kv{
    display:grid;
    grid-template-columns:100px 1fr;
    gap:8px;
    margin-top:6px;
  }
  .k{ color:var(--muted); }
  .v{ font-weight:700; }

  .stats{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:6px;
  }
  .stat{
    background:#161821;
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px;
    text-align:center;
  }
  .stat b{
    display:block;
    font-size:20px;
    margin-top:4px;
  }

  .btns{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .btn{
    background:#1b1e29;
    border:1px solid var(--line);
    color:var(--ink);
    border-radius:10px;
    padding:10px 14px;
    text-align:center;
    cursor:pointer;
    flex:1 1 auto;
    min-width:110px;
    font-size:14px;
  }
  .btn.primary{
    background:var(--accent);
    color:#0b0c12;
    font-weight:800;
    border:none;
  }

  /* RIGHT: STUDY LIST */
  .studies-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:14px;
  }

  .studies-head h2{
    margin:0;
    font-size:18px;
    white-space:nowrap;
  }

  .study-find-btn{
    padding:10px 14px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#1b1e29;
    font-size:14px;
  }

  .list{
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .study-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#161821;
    padding:10px 14px;
    border-radius:10px;
    border:1px solid var(--line);
  }

  .study-item .left{
    font-size:14px;
    font-weight:600;
  }

  .study-item .enter{
    padding:6px 12px;
    border-radius:8px;
    border:1px solid var(--line);
    font-size:13px;
  }

  /* ---------- MODAL POPUP ---------- */
  .avatar-modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.55);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:200;
  }
  .avatar-modal.hidden{
    display:none !important;
  }

  .avatar-modal-content{
    background:#161821;
    border-radius:16px;
    border:1px solid var(--line);
    padding:18px 20px 16px;
    width:520px;
    max-width:92vw;
    box-shadow:0 18px 40px rgba(0,0,0,0.45);
  }

  .avatar-modal-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }
  .avatar-modal-title{
    font-size:16px;
    font-weight:700;
  }
  .avatar-modal-close{
    cursor:pointer;
    font-size:22px;
    color:var(--muted);
  }

  .avatar-picker-grid{
    display:grid;
    grid-template-columns:repeat(5, 1fr);
    gap:10px;
    margin:8px 0 14px;
  }

  .avatar-option{
    width:70px;
    height:70px;
    border-radius:50%;
    background-size:cover;
    background-position:center;
    cursor:pointer;
    border:2px solid transparent;
    transition:border-color 0.15s ease, transform 0.1s ease;
  }
  .avatar-option:hover{
    border-color:var(--accent);
    transform:translateY(-2px);
  }
  .avatar-option.selected{
    border-color:var(--accent);
  }

  .avatar-modal-footer{
    display:flex;
    justify-content:flex-end;
  }
  .avatar-confirm-btn{
    padding:10px 18px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    background:var(--accent);
    color:#0b0c12;
    font-weight:700;
  }
</style>


<div class="wrap">
  <!-- LEFT: PROFILE -->
  <section class="panel profile">
    <div class="row">
      <!-- í˜„ì¬ ì €ì¥ëœ ì•„ë°”íƒ€ ì¸ë±ìŠ¤ë¥¼ data-current-indexì— ë„£ì–´ì¤Œ -->
      <div class="avatar"
           id="avatar"
           data-current-index="{{ user.profile.avatar_index|default:1 }}"></div>

      <div>
        <div style="font-weight:900; font-size:20px;">
          {{ user.profile.nickname|default:user.username }}
        </div>
        <div style="color:var(--muted);">@{{ user.username }}</div>
      </div>
    </div>

    <div class="kv">
      <div class="k">ì´ë©”ì¼</div>
      <div class="v">{{ user.email }}</div>

      <div class="k">ë ˆë²¨</div>
      <div class="v">Lv. {{ user.profile.level }}</div>

      <div class="k">ê°€ì…ì¼</div>
      <div class="v">{{ user.date_joined|date:"Y-m-d" }}</div>
    </div>

    <div class="stats">
      <div class="stat">
        <span>ì´ ì§‘ì¤‘ì‹œê°„</span>
        <b>{{ total_study_time_sum }}</b>
      </div>
    </div>

    <div class="btns">
      <button class="btn" id="edit-profile-btn">í”„ë¡œí•„ í¸ì§‘</button>
      <div class="btn">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
      <a href="{% url 'login' %}" class="btn primary">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
  </section>


  <!-- RIGHT: STUDY LIST -->
  <section class="panel">
    <div class="studies-head">
      <h2>ê°€ì…ëœ ìŠ¤í„°ë””</h2>
      <a href="{% url 'board' %}" class="study-find-btn">+ ìƒˆ ìŠ¤í„°ë”” ì°¾ê¸°</a>
    </div>

    <div class="list">
      <div class="study-item">
        <div class="left">ì›¹í”„ë¡œê·¸ë˜ë° ìŠ¤í„°ë””</div>
        <a class="enter" href="{% url 'timer' group_code='GROUP1' %}">ì…ì¥</a>
      </div>
      <div class="study-item">
        <div class="left">ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë””</div>
        <a class="enter" href="{% url 'timer' group_code='GROUP2' %}">ì…ì¥</a>
      </div>
      <div class="study-item">
        <div class="left">ì»´í“¨í„°êµ¬ì¡° ìŠ¤í„°ë””</div>
        <a class="enter" href="{% url 'timer' group_code='GROUP3' %}">ì…ì¥</a>
      </div>
    </div>
  </section>
</div>


<!-- ğŸ”µ ì•„ë°”íƒ€ ì„ íƒ ëª¨ë‹¬ -->
<div id="avatar-modal" class="avatar-modal hidden">
  <div class="avatar-modal-content">

    <div class="avatar-modal-header">
      <div class="avatar-modal-title">í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ</div>
      <div class="avatar-modal-close" id="avatar-modal-close">&times;</div>
    </div>

    <div class="avatar-picker-grid">
      <div class="avatar-option" data-index="1"></div>
      <div class="avatar-option" data-index="2"></div>
      <div class="avatar-option" data-index="3"></div>
      <div class="avatar-option" data-index="4"></div>
      <div class="avatar-option" data-index="5"></div>
      <div class="avatar-option" data-index="6"></div>
      <div class="avatar-option" data-index="7"></div>
      <div class="avatar-option" data-index="8"></div>
      <div class="avatar-option" data-index="9"></div>
      <div class="avatar-option" data-index="10"></div>
    </div>

    <div class="avatar-modal-footer">
      <button id="avatar-confirm-btn" class="avatar-confirm-btn">í™•ì¸</button>
    </div>

  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {

  const avatarDiv = document.getElementById("avatar");
  const modal = document.getElementById("avatar-modal");
  const editBtn = document.getElementById("edit-profile-btn");
  const closeBtn = document.getElementById("avatar-modal-close");
  const confirmBtn = document.getElementById("avatar-confirm-btn");

  const options = document.querySelectorAll(".avatar-option");

  // static ê²½ë¡œ prefix (ì˜ˆ: /static/img/)
  const staticBase = "{% static 'img' %}/";

  // í˜„ì¬ ì €ì¥ëœ ì¸ë±ìŠ¤ (ì—†ìœ¼ë©´ 1)
  let selectedIndex = parseInt(avatarDiv.dataset.currentIndex || "1", 10);
  let pendingIndex = selectedIndex;

  // í”„ë¡œí•„ ì´ë¯¸ì§€ ì ìš© í•¨ìˆ˜
  function applyAvatar(index) {
    avatarDiv.style.backgroundImage = "url('" + staticBase + "cat_" + index + ".png')";
  }

  // ì„ íƒ UI ì—…ë°ì´íŠ¸
  function updateSelectionUI() {
    options.forEach(function (opt) {
      opt.classList.remove("selected");
      if (parseInt(opt.dataset.index, 10) === pendingIndex) {
        opt.classList.add("selected");
      }
    });
  }

  // ì´ˆê¸° ìƒíƒœ ë°˜ì˜
  applyAvatar(selectedIndex);
  updateSelectionUI();

  // ê° ì˜µì…˜ì— ì´ë¯¸ì§€ ë°°ê²½ ì ìš©
  options.forEach(function (opt) {
    const n = opt.dataset.index;
    opt.style.backgroundImage = "url('" + staticBase + "cat_" + n + ".png')";
  });

  // ëª¨ë‹¬ ì—´ê¸°
  editBtn.addEventListener("click", function () {
    modal.classList.remove("hidden");
  });

  // ë‹«ê¸°(X)
  closeBtn.addEventListener("click", function () {
    modal.classList.add("hidden");
  });

  // ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
  modal.addEventListener("click", function (e) {
    if (e.target === modal) {
      modal.classList.add("hidden");
    }
  });

  // ì˜µì…˜ í´ë¦­
  options.forEach(function (opt) {
    opt.addEventListener("click", function () {
      pendingIndex = parseInt(opt.dataset.index, 10);
      updateSelectionUI();
    });
  });

  // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  // í™•ì¸ â†’ UI ë°˜ì˜ + ì„œë²„ ì €ì¥
  confirmBtn.addEventListener("click", function () {

    // í”„ë¡ íŠ¸ì—ì„œ ì¦‰ì‹œ ë°˜ì˜
    applyAvatar(pendingIndex);
    selectedIndex = pendingIndex;

    // ì„œë²„ì— ì €ì¥ ìš”ì²­
    fetch("/profile/update-avatar/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify({
        avatar_index: pendingIndex
      })
    }).then(function (res) {
      return res.json();
    }).then(function (data) {
      console.log("Saved:", data);
    }).catch(function (err) {
      console.error("avatar update error", err);
    });

    modal.classList.add("hidden");
  });
});
</script>

{% endblock %}
